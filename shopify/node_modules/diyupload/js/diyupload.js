(function($){
$.fn.extend({diyUpload:function(opt,serverCallBack){
if(typeof opt!="object"){alert('params error!');return;}
var $fileInput=$(this);var $fileInputId=$fileInput.attr('id');
opt.multiple=false;
if (!opt.getTokenUrl) {
    opt.getTokenUrl = "/api/ossapi/gettoken"
}
if (!opt.getTokenUrl) {
    opt.getTokenUrlData = {}
}
if(opt.url){opt.server=opt.url;delete opt.url;}
if(opt.success){var successCallBack=opt.success;delete opt.success;}
if(opt.error){var errorCallBack=opt.error;delete opt.error;}
$.each(getOption('#'+$fileInputId),function(key,value){opt[key]=opt[key]||value;});
if(opt.buttonText){opt['pick']['label']=opt.buttonText;delete opt.buttonText;}
var webUploader=getUploader(opt);
if(!WebUploader.Uploader.support()){alert('Your browser is not supported upload.');return false;}
webUploader.on('fileQueued',function(file){$('.review_save').addClass('btn-progress');createBox($fileInput,file,webUploader,opt);});
webUploader.on('uploadProgress',function(file,percentage){
	var $fileBox=$('#fileBox_'+file.id);
	var $diyBar=$fileBox.find('.diyBar');
	$diyBar.show();
	percentage=percentage*100;
	showDiyProgress(percentage.toFixed(2),$diyBar);
});
webUploader.on('uploadBeforeSend', function (obj, data, headers) {  
    var arr = eval(opt.data_arr)
    //判断是图还是视频，存放在不同的数组中
    console.log(data.type.split("/")[0])
    if (data.type.split("/")[0] == 'image') {
        is_image = true;
    }else if(data.type.split("/")[0] == 'video'){
        is_image = false;
    }else{
        return;
    }
	var img_name = random_string(10)+get_suffix(data.name)
    $.ajax({  
        type : "POST",  
        url : opt.getTokenUrl,
        data: opt.getTokenUrlData,
        timeout : 10000,  
        dataType:"JSON",
        success : function(obj2) {  
            arr.unshift(obj2.data.host+'/'+obj2.data.dir + img_name);
            data = $.extend(data,{
                        'key' : obj2.data.dir + img_name,//这里最好在后台处理好
                        'policy': obj2.data.policy,
                        'OSSAccessKeyId': obj2.data.accessid, 
                        'success_action_status' : '200', //让服务端返回200,不然，默认会返回204
                        'callback' : obj2.data.callback,
                        'signature': obj2.data.signature,
                    });
        },  
        error : function(XMLHttpRequest, textStatus, errorThrown) {  
            alert("ajax error");  
        },  
        async : false 
    });  
    headers['Access-Control-Allow-Origin'] = "*";  
});
webUploader.on('uploadFinished',
function() {
    $fileInput.next('.parentFileBox').children('.diyButton').remove();
});
webUploader.on('uploadAccept',
function(object, data) {
    if (serverCallBack) serverCallBack(data);
});
webUploader.on('uploadSuccess',
function(file, response) {
    var $fileBox = $('#fileBox_' + file.id);
    var $diyBar = $fileBox.find('.diyBar');
    showDiyProgress(100, $diyBar, 'Upload success.');
    /*new add $fileBox.removeClass('diyUploadHover');*/
    $diyBar.fadeOut(1000,
    function() {
        $fileBox.children('.diySuccess').show();
    });
    if (successCallBack) {
        successCallBack(response,  $fileBox);
    }
});
webUploader.on('uploadError',
function(file, reason) {
    var $fileBox = $('#fileBox_' + file.id);
    var $diyBar = $fileBox.find('.diyBar');
    showDiyProgress(0, $diyBar, 'Upload failed.');
    var err = 'Upload failed. file:' + file.name + ' error:' + reason;
    if (errorCallBack) {
        errorCallBack(err);
    }
});
webUploader.on('error',
    function(code) {
        var text = '';
        switch (code) {
        case 'F_DUPLICATE':
            text = 'review_been_selected';
            break;
        case 'Q_EXCEED_NUM_LIMIT':
            text = 'review_number_exceeds_limit';
            break;
        case 'F_EXCEED_SIZE':
            text = 'review_file_size_exceeds_limit';
            break;
        case 'Q_EXCEED_SIZE_LIMIT':
            text = 'review_file_total_size_exceeds_limit';
            break;
        case 'Q_TYPE_DENIED':
            text = 'review_invalid_file_type';
            break;
        default:
            text = 'review_unknown_error';
            break;
    }
    iziToast.error({
        message: __(text),
        position: 'topCenter'
    });
    $('.review_save').removeClass('btn-progress');
});

return webUploader;}});

function getOption(objId){return{auto:true,pick:{id:objId,label:""},accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},thumb:{width:160,height:120,quality:90,allowMagnify:false,crop:true,type:"image/jpeg"},method:"POST",server:"",sendAsBinary:false,chunked:false,fileNumLimit:1,fileSizeLimit:1*1024,fileSingleSizeLimit:2*1024};}
function getUploader(opt){return new WebUploader.Uploader(opt);}
function showDiyProgress(progress,$diyBar,text){progress=progress+'%';text=text||progress;var $diyProgress=$diyBar.find('.diyProgress');$diyProgress.width(progress).text(text);}

function createBox($fileInput, file, webUploader,opt) {
    var viewbox = opt.viewbox;
    var file_id = file.id;
    var $parentFileBox = $fileInput.parents(".upload-ul");
    var file_len = $parentFileBox.children(".diyUploadHover").length;
    var style_width = '';
    if (opt.type == 'video') {
        style_width = 'video_box';
    }
    var li = '<li id="fileBox_' + file_id + '" class="diyUploadHover '+style_width+'"><div class="viewThumb '+opt.data_arr+'"><div class="diyBar"><div class="diyProgress">0%</div></div><p class="diyControl" data-arr="'+opt.data_arr+'" data-input="'+opt.input+'" data-viewbox="'+viewbox+'"><span class="diyLeft"><i></i></span><span class="diyCancel"><i></i></span><span class="diyRight"><i></i></span></p></div></li>';
    $parentFileBox.prepend(li);
    var $fileBox = $parentFileBox.find('#fileBox_' + file_id);
    var $diyCancel = $fileBox.find('.diyCancel').one('click',
    function() {
        console.log($(this).parents('.diyUploadHover'), file_id, webUploader);
        removeLi($(this).parents('.diyUploadHover'), file_id, webUploader,opt);
    });
    if (file.type.split("/")[0] != opt.type) {
        var liClassName = getFileTypeClassName(file.name.split(".").pop());
        $fileBox.addClass(liClassName);
        return;
    }
    if (opt.type == 'video') {
        $fileBox.find('.viewThumb').append(`<div class="${viewbox}" data-src="" data-id="20" style="background: #f7f7f7;"><svg t="1604068612250" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1157" width="36" height="36"><path d="M426.666667 682.666667V384l256 149.845333L426.666667 682.666667z m587.093333-355.541334s-10.026667-71.04-40.704-102.357333c-38.954667-41.088-82.602667-41.258667-102.613333-43.648C727.168 170.666667 512.213333 170.666667 512.213333 170.666667h-0.426666s-214.954667 0-358.229334 10.453333c-20.053333 2.389333-63.658667 2.56-102.656 43.648-30.677333 31.317333-40.661333 102.4-40.661333 102.4S0 410.538667 0 493.952v78.293333c0 83.456 10.24 166.912 10.24 166.912s9.984 71.04 40.661333 102.357334c38.997333 41.088 90.154667 39.765333 112.938667 44.074666C245.76 893.568 512 896 512 896s215.168-0.341333 358.442667-10.752c20.053333-2.432 63.658667-2.602667 102.613333-43.690667 30.72-31.317333 40.704-102.4 40.704-102.4s10.24-83.413333 10.24-166.869333v-78.250667c0-83.456-10.24-166.912-10.24-166.912z" fill="#FF0000" p-id="1158"></path></svg></div>`);
    }
    webUploader.makeThumb(file,
    function(error, dataSrc,opt) {
        if (!error) {
            $fileBox.find('.viewThumb').append(`
                <div class="spotlight" data-src="${dataSrc}" style="background-image:url(${dataSrc})"></div>
                <img class="${viewbox}" data-src="${dataSrc}">
                            `); 
        }
    });
}
function getFileTypeClassName(type){var fileType={};var suffix='_diy_bg';fileType['pdf']='pdf';fileType['ppt']='ppt';fileType['doc']='doc';fileType['docx']='doc';fileType['jpg']='jpg';fileType['zip']='zip';fileType['rar']='rar';fileType['xls']='xls';fileType['xlsx']='xls';fileType['txt']='txt';fileType=fileType[type]||'ppt';return fileType+suffix;}
//获取
function get_suffix(filename) {
    var pos = filename.lastIndexOf('.')
    var suffix = ''
    if (pos != -1) {
        suffix = filename.substring(pos)
    }
    return suffix;
}
function random_string(len) {
　　len = len || 32;
　　var chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';   
　　var maxPos = chars.length;
　　var pwd = '';
　　for (i = 0; i < len; i++) {
    　　pwd += chars.charAt(Math.floor(Math.random() * maxPos));
    }
    return pwd;
}  
function removeLi($li,file_id,webUploader,opt){
    webUploader.removeFile(file_id);$li.remove();
    setData(eval(opt.data_arr),opt.viewbox,opt.input);
}
function leftLi($leftli,$li,arr,viewbox,input){$li.insertBefore($leftli);setData(arr,viewbox,input);}
function rightLi($rightli,$li,arr,viewbox,input){$li.insertAfter($rightli);setData(arr,viewbox,input);}  
function setData(arr,viewbox,input){
    var arr = [];
    $('.'+viewbox).each(function(){
        arr.push($(this).attr("data-src"));
    });
    var reviewPhotoText = arr.join(',');
    $('.'+input).val(reviewPhotoText);
    // console.log(reviewPhotoText)
    // eval(arr_text+'=arr')
    // console.log(eval(arr_text))
}
$(document).on('click', '.diyLeft', function () {
    var thatDiyControl = $(this).parents('.diyControl');
    console.log(111)
    leftLi($(this).parents('.diyUploadHover').prev(), $(this).parents('.diyUploadHover'),thatDiyControl.data('arr'),thatDiyControl.data('viewbox'),thatDiyControl.data('input'));
});
$(document).on('click', '.diyRight', function () {
    var thatDiyControl = $(this).parents('.diyControl');
    console.log(222)
    rightLi($(this).parents('.diyUploadHover').next(), $(this).parents('.diyUploadHover'),thatDiyControl.data('arr'),thatDiyControl.data('viewbox'),thatDiyControl.data('input'));
});
$(document).on('click', '.diyCancel', function () {
    var thatDiyControl = $(this).parents('.diyControl');
    $(this).parents('.diyControl').next().attr('class');
    $(this).parents('.diyUploadHover').remove();
    setData(thatDiyControl.data('arr'),thatDiyControl.data('viewbox'),thatDiyControl.data('input'));
});
})(jQuery);